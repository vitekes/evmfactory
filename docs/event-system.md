# Система событий в проекте

## Обзор

В нашем проекте используются два механизма для событий:

1. **Стандартные события Solidity** - для контрактов ядра и обратной совместимости
2. **Централизованный EventRouter** - для межмодульных и бизнес-событий

## Рекомендации по использованию

### Когда использовать стандартные события Solidity?

- Для технических событий внутри контракта (например, административные действия)
- Для обратной совместимости с существующими системами
- Для внутренних индексаторов и логики контракта

### Когда использовать EventRouter?

- Для всех бизнес-событий, которые должны быть доступны между модулями
- Для событий, которые могут потребовать обработки в других модулях
- Для событий, формат которых может измениться в будущем

## Правила эмиссии событий

Для корректной работы системы рекомендуется придерживаться следующего подхода:

```solidity
// Для технического события достаточно обычного emit
emit TechnicalEvent(param1, param2);

// Для бизнес-события используем оба механизма
// 1. Сначала стандартное событие для обратной совместимости
emit BusinessEvent(param1, param2);

// 2. Затем дублируем через EventRouter для межмодульного взаимодействия
address router = registry.getModuleService(moduleId, CoreDefs.SERVICE_EVENT_ROUTER);
if (router != address(0)) {
    IEventRouter(router).route(
        IEventRouter.EventKind.BusinessEvent,
        abi.encode(param1, param2, версия)
    );
}
```

## План миграции

Чтобы унифицировать систему событий, следуйте этому плану:

1. Для всех контрактов ядра:
   - Всегда сначала эмитируйте стандартное событие
   - Дополнительно используйте EventRouter, если он доступен

2. Для новых модулей:
   - Используйте только EventRouter для бизнес-событий
   - Используйте стандартные события только для технических деталей

3. Для обновления существующих модулей:
   - Сохраните существующие события для обратной совместимости
   - Добавьте параллельное использование EventRouter для всех бизнес-событий

## Версионирование

Все события через EventRouter должны включать номер версии формата данных:

```solidity
abi.encode(param1, param2, uint16(1)) // 1 - номер версии формата
```

Это позволяет обрабатывать изменения в формате событий в будущем.
