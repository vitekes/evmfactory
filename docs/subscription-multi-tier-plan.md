# Multi-Subscription Upgrade Plan

## Контекст
- Базовый контракт `SubscriptionManager` (`contracts/modules/subscriptions/SubscriptionManager.sol`) хранит единственную подписку на адрес через `mapping(address => Subscriber)` и поддерживает как ERC-20, так и нативные платежи.
- Планы задаются оффчейн, подписываются мерчантом по EIP-712 и заносятся в `plans[planHash]`. Скидки/дополнительные правила обрабатываются существующей платежной инфраструктурой (`PaymentGateway`, Discount/TokenFilter процессоры).
- Автосписания выполняются через `charge` и `chargeBatch`, запускаются со стороны `PaymentGateway` и пока не учитывают различия между планами одного автора.
- Нужно поддержать «патреон на крипте»: авторы создают несколько уровней (tiers), подписчик выбирает один активный план у конкретного автора, пробных периодов нет (допустима только ручная активация администратором), требуется корректный жизненный цикл подписки с автосписаниями и отменой.

## Требования продукта
- **Множественные уровни:** автор может держать несколько планов (Tier 1, 2, 3) с разными ценами и описанием.
- **Ограничение подписки:** у пользователя только один активный план на автора; новый план отключает прежний.
- **Статусы:** используем `active` / `inactive`; активация после списания или ручного включения, деактивация по отмене, окончанию периода или повторной неудаче.
- **Права автора:** полный CRUD над планами, управление ценой и описанием без пробных периодов.
- **Платёжный поток:** все списания через `PaymentGateway`, не чаще одного раза в 30 дней.
- **Неудачные списания:** `PaymentGateway` делает один ретрай через 24 часа; вторая неудача переводит подписку в `inactive`, бэкенд уведомляет пользователя.
- **Пробные периоды:** отсутствуют; ручная активация или продление возможны только администратором.
- **Депозиты и лимиты:** дополнительные депозиты и квоты не требуются; действует ограничение «один активный план на автора».
- **KYC/AML:** проверки остаются вне on-chain контура.
- **Аналитика:** контракт эмитирует события по подпискам, автосписаниям и отменам; уведомления и обработка — на бэкенде.

## Архитектурные акценты
- Перейти на хранение подписок по ключу `(user, planHash)` и явно контролировать, что для одного автора есть не более одной активной записи.
- Добавить модуль управления планами (отдельный контракт/модуль) с правами автора и интеграцией в `CoreSystem` ACL, что позволит включать/выключать планы и обновлять условия.
- Обновить API и события `subscribe`, `subscribeWithToken`, `unsubscribe`, `charge`, `chargeBatch`, чтобы передавать идентификатор плана, фиксировать переходы `active`/`inactive` и обозначать повторные попытки списания.
- Сохранить совместимость с `PaymentGateway`, DiscountProcessor, TokenFilter, Permit/Permit2 и сделать `PaymentGateway` единственным инициатором автосписаний; депозиты не используются.
- Предусмотреть view-функции для фронтенда: активные планы автора, текущая подписка пользователя, дата следующего списания, дата ретрая и история статусов.

## План работ
1. **Финализация требований**  
   Подтвердить статусы, ограничение одного плана на автора, параметры автосписания (30 дней, ретрай 24 часа) и отсутствие пробного периода.

2. **Архитектурный дизайн**  
   Описать хранение `(user, planHash)`, последовательности `SubscriptionManager` + `PaymentGateway` (подписка, отмена, автосписание, ретрай) и ручную активацию админом.

3. **Детальный дизайн контрактов**  
   - Обновить структуры и события `SubscriptionManager` с учётом `active/inactive`.
   - Описать модуль планов и проверку одной активной записи на автора.
   - Согласовать gas и совместимость.

4. **Реализация**  
   - Внедрить ключ `(user, planHash)` и статусы без депозитов.
   - Обновить view-функции и события.
   - Связать модуль планов с ACL и `PaymentGateway`.

5. **Интеграция off-chain**  
   - Настроить `PaymentGateway` (автосписание 30 дней, ретрай 24 часа).
   - Обновить бэкенд и API/ABI.

6. **Тестирование**  
   - Добавить юнит-и интеграционные тесты на ограничение одного плана и ретрай.
   - Дополнить fuzz/invariant проверки и демо-сценарии.

7. **Инфраструктура и релиз**  
   - Обновить миграции, документацию и чек-листы.
   - Провести dry-run и релиз после подтверждения.

## Открытые вопросы
- Нет — все ключевые вопросы согласованы; аналитика/уведомления реализуются на бэкенде, KYC/AML вне контракта.

## Следующие шаги
1. Проверить обновлённый документ и подтвердить финальную версию требований.
2. Запустить подготовку архитектурной спецификации на базе этих требований.

## Задачи

#### Задача 1. Финализация требований
- **Описание**: зафиксировать финальную версию продуктовых требований для мульти-тир модели.
- **Шаги**:
  1. Свести принятые решения по уровням, статусам, автосписанию и ограничению одного плана.
  2. Проверить, что сценарии подписки, отмены и ретрая описаны без пробелов.
  3. Получить ваше подтверждение и отметить требования как утверждённые.
- **Ожидаемый результат**: документ требований обновлён и утверждён владельцем продукта.
- **Критерии приёмки**: DoR — решения по статусам, автосписаниям и ограничению перечислены; DoD — документ подтверждён владельцем; AC — сценарии подписки/отмены/ретрая и ограничение на один план описаны без пробелов.

#### Задача 2. Архитектурный дизайн
- **Описание**: подготовить архитектурную спецификацию для новой модели подписок.
- **Шаги**:
  1. Разработать модель `(user, planHash)` с признаком активности, датами следующего списания и ретрая, а также проверкой одного плана на автора.
  2. Подготовить последовательности `SubscriptionManager`, менеджера планов и `PaymentGateway` для подписки, отмены, автосписания и ретрая.
  3. Описать ручную активацию администратором и уведомления о неудачных попытках.
  4. Передать документ на ваше утверждение и зафиксировать согласование.
- **Ожидаемый результат**: архитектурная спецификация утверждена владельцем продукта.
- **Критерии приёмки**: DoR — требования финализированы; DoD — документ утверждён вами; AC — диаграмы и описание покрывают подписку, отмену, автосписание и ретрай с ограничением на один активный план.
