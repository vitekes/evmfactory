# Использование ценовых оракулов в системе

## Обзор архитектуры

В нашей системе реализована архитектура ценообразования, основанная на **расчётной конвертации** токенов, а не на их фактическом обмене. Это важное отличие от DEX-подобных систем.

## Принцип работы

1. **Базовая цена** - все товары/услуги имеют цену в базовом токене (например, USDC)
2. **Расчет эквивалента** - система позволяет рассчитать эквивалент в других токенах
3. **Платеж в выбранном токене** - пользователь платит тем токеном, который ему удобен

## Компоненты системы

### ChainlinkPriceOracle

- Обеспечивает данные о ценах токенов через Chainlink
- Предоставляет метод `convertAmount` для расчета эквивалентных сумм
- Не выполняет реальный обмен токенов

### PaymentGateway

- Предоставляет метод `calculatePaymentAmount` для определения суммы к оплате
- Обрабатывает платежи в разных токенах через `processPayment`
- Валидирует токены через `MultiValidator`

## Преимущества подхода

1. **Простота для пользователя** - выбор предпочтительного токена
2. **Отсутствие потерь на свопе** - нет скольжения цены и комиссий за обмен
3. **Гибкость** - легкое добавление поддержки новых токенов
4. **Прозрачность** - пользователь всегда видит точную сумму перед оплатой

## Пример использования

```javascript
// Пример для маркетплейса
async function purchaseItem(listingId, paymentToken) {
  // 1. Получаем информацию о листинге
  const listing = await marketplace.listings(listingId);

  // 2. Рассчитываем сумму к оплате в выбранном токене
  const paymentAmount = await gateway.calculatePaymentAmount(
    moduleId,
    listing.baseToken,  // Например, USDC
    paymentToken,       // Например, ETH
    listing.basePrice   // Например, 100 USDC
  );

  // 3. Показываем пользователю сумму к оплате
  console.log(`Цена: ${listing.basePrice} ${listing.baseToken} (≈ ${paymentAmount} ${paymentToken})`);

  // 4. Пользователь подтверждает и отправляем транзакцию
  await marketplace.purchaseItem(listingId, paymentToken);
}
```

## Рекомендации по интеграции

1. **Всегда указывайте базовую цену** в стабильном токене (USDC, USDT, DAI)
2. **Предлагайте несколько вариантов оплаты** для лучшего UX
3. **Кэшируйте расчеты конвертации** на фронтенде для снижения нагрузки
4. **Обновляйте расчеты** перед финализацией платежа для точности

## Ограничения

1. Точность конвертации зависит от актуальности данных Chainlink
2. Нет защиты от волатильности в момент между расчетом и платежом
3. Требуется дополнительная валидация для редких токенов
